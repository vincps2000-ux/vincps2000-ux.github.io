<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Vincent Untiedt Tech Experimentation Blog</title>
        <script>
            /* Apply theme ASAP to avoid flash */
            (function(){
                const saved = localStorage.getItem('theme');
                if(saved === 'dark' || saved === 'light'){
                    document.documentElement.setAttribute('data-theme', saved);
                }
            })();
        </script>
        <style>
            /* ---- Light theme (default) ---- */
            :root,
            [data-theme="light"]{
                --bg: #f7f7fb;
                --bg-end: #eef2ff;
                --card: #ffffff;
                --accent: #2b6cb0;
                --muted: #666;
                --text: #111;
                --text-secondary: #222;
                --border: #ddd;
                --input-bg: #fff;
                --code-bg: #e8e8e8;
            }
            /* ---- Dark theme ---- */
            [data-theme="dark"]{
                --bg: #181a20;
                --bg-end: #1e2028;
                --card: #23252e;
                --accent: #5b9bf5;
                --muted: #9ca3af;
                --text: #e4e4e7;
                --text-secondary: #d1d5db;
                --border: #3a3d47;
                --input-bg: #23252e;
                --code-bg: #2d2f39;
            }
            /* OS preference when no manual choice */
            @media (prefers-color-scheme: dark){
                :root:not([data-theme]){
                    --bg: #181a20;
                    --bg-end: #1e2028;
                    --card: #23252e;
                    --accent: #5b9bf5;
                    --muted: #9ca3af;
                    --text: #e4e4e7;
                    --text-secondary: #d1d5db;
                    --border: #3a3d47;
                    --input-bg: #23252e;
                    --code-bg: #2d2f39;
                }
            }
            html,body{height:100%;}
            body {
                margin: 0;
                font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
                background: linear-gradient(180deg,var(--bg),var(--bg-end));
                color: var(--text);
                padding: 2rem;
                transition: background .3s, color .3s;
            }
            .site {
                max-width: 860px;
                margin: 0 auto;
            }
            header {
                display:flex;
                align-items:center;
                justify-content:space-between;
                gap:1rem;
                margin-bottom:1rem;
            }
            h1 {font-size:1.25rem;margin:0}
            .subtitle{color:var(--muted);font-size:0.95rem}

            .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
            .search{padding:.5rem .75rem;border-radius:6px;border:1px solid var(--border);background:var(--input-bg);color:var(--text)}
            .select{padding:.5rem .5rem;border-radius:6px;border:1px solid var(--border);background:var(--input-bg);color:var(--text)}

            .posts{display:flex;flex-direction:column;gap:.75rem}
            details.post{
                background:var(--card);
                border-radius:8px;
                padding:0.5rem 0.75rem;
                box-shadow:0 1px 3px rgba(0,0,0,0.08);
                overflow:hidden;
                transition: background .3s;
            }
            summary.post-header{
                list-style:none;cursor:pointer;display:flex;align-items:center;gap:.75rem;padding:.25rem 0;
                font-weight:600;color:var(--accent);
            }
            summary.post-header::-webkit-details-marker{display:none}

            .meta{color:var(--muted);font-weight:400;font-size:.9rem}
            .post-content{padding:.5rem 0 0 .25rem;color:var(--text-secondary);white-space:pre-wrap;font-family: "Segoe UI", Roboto, Arial, sans-serif}
            .post-content img{max-width:100%;height:auto;border-radius:6px;margin:.5rem 0;display:block}
            .post-content a{color:var(--accent);text-decoration:underline;word-break:break-all}
            .post-content a:hover{opacity:.8}

            .empty{padding:2rem;text-align:center;color:var(--muted);background:transparent}
            a.fresh{font-size:.85rem;color:var(--accent);text-decoration:none}

            code{background:var(--code-bg);padding:.1em .35em;border-radius:4px;font-size:.9em}

            .theme-toggle{
                background:var(--input-bg);border:1px solid var(--border);border-radius:6px;
                padding:.4rem .6rem;cursor:pointer;font-size:1.1rem;line-height:1;
                color:var(--text);transition:background .3s,border-color .3s;
                display:flex;align-items:center;justify-content:center;
            }
            .theme-toggle:hover{border-color:var(--accent)}

            /* ---- Tabs ---- */
            .tabs{
                display:flex;gap:0;margin-bottom:1rem;
            }
            .tab-btn{
                flex:1;padding:.6rem 1rem;border:1px solid var(--border);background:var(--input-bg);
                color:var(--muted);font-weight:600;font-size:.95rem;cursor:pointer;
                transition:background .2s,color .2s,border-color .2s;
            }
            .tab-btn:first-child{border-radius:8px 0 0 8px}
            .tab-btn:last-child{border-radius:0 8px 8px 0}
            .tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
            .tab-panel{display:none}
            .tab-panel.active{display:block}

            /* ---- Calendar ---- */
            .cal-nav{
                display:flex;align-items:center;justify-content:space-between;
                margin-bottom:.75rem;
            }
            .cal-nav button{
                background:var(--input-bg);border:1px solid var(--border);border-radius:6px;
                padding:.35rem .7rem;cursor:pointer;font-size:1rem;color:var(--text);
                transition:border-color .2s;
            }
            .cal-nav button:hover{border-color:var(--accent)}
            .cal-month-label{font-weight:700;font-size:1.05rem}
            .cal-grid{
                display:grid;grid-template-columns:repeat(7,1fr);gap:4px;
            }
            .cal-day-name{
                text-align:center;font-size:.8rem;font-weight:600;color:var(--muted);padding:.25rem 0;
            }
            .cal-cell{
                aspect-ratio:1;display:flex;align-items:center;justify-content:center;
                border-radius:6px;font-size:.85rem;color:var(--text);position:relative;
            }
            .cal-cell.empty{visibility:hidden}
            .cal-cell.has-post{
                background:#22c55e;color:#fff;font-weight:700;cursor:pointer;
                box-shadow:0 1px 4px rgba(34,197,94,.35);
            }
            .cal-cell.has-post:hover{background:#16a34a}
            .cal-cell.today{outline:2px solid var(--accent);outline-offset:-2px;border-radius:6px}
            .cal-tooltip{
                display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);
                background:var(--card);border:1px solid var(--border);border-radius:6px;
                padding:.35rem .6rem;font-size:.78rem;white-space:nowrap;z-index:10;
                box-shadow:0 2px 8px rgba(0,0,0,.15);color:var(--text);
            }
            .cal-cell.has-post:hover .cal-tooltip{display:block}

            /* ---- Stats panel ---- */
            .stats-controls{
                display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;
                margin-bottom:1rem;
            }
            .stats-controls label{
                font-weight:600;font-size:.9rem;color:var(--muted);
            }
            .stats-controls select{
                padding:.45rem .6rem;border-radius:6px;border:1px solid var(--border);
                background:var(--input-bg);color:var(--text);font-size:.9rem;
            }
            .stats-empty{
                padding:2rem;text-align:center;color:var(--muted);font-size:.95rem;
            }
            .chart-container{
                background:var(--card);border-radius:8px;padding:1rem;
                box-shadow:0 1px 3px rgba(0,0,0,0.08);
                position:relative;height:350px;
            }
            .stats-summary{
                display:flex;gap:1rem;flex-wrap:wrap;margin-top:1rem;
            }
            .stat-card{
                flex:1;min-width:140px;background:var(--card);border-radius:8px;
                padding:.75rem 1rem;box-shadow:0 1px 3px rgba(0,0,0,0.08);
                text-align:center;
            }
            .stat-card .stat-value{
                font-size:1.4rem;font-weight:700;color:var(--accent);
            }
            .stat-card .stat-label{
                font-size:.8rem;color:var(--muted);margin-top:.2rem;
            }

            /* ---- Demo panel ---- */
            .demo-grid{
                display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem;
            }
            .demo-card{
                background:var(--card);border-radius:8px;padding:1.25rem;
                box-shadow:0 1px 3px rgba(0,0,0,0.08);transition:background .3s;
            }
            .demo-card h3{
                margin:0 0 .5rem;font-size:1rem;color:var(--accent);
            }
            .demo-card p.demo-desc{
                font-size:.85rem;color:var(--muted);margin:0 0 1rem;
            }

            /* Star rating widget */
            .star-widget{
                display:flex;flex-direction:column;align-items:center;gap:.75rem;
            }
            .star-display{
                display:flex;gap:4px;font-size:2.2rem;user-select:none;
            }
            .star-unit{
                position:relative;display:inline-block;color:var(--border);
            }
            .star-unit .star-fill{
                position:absolute;top:0;left:0;overflow:hidden;color:#f59e0b;white-space:nowrap;
            }
            .star-controls{
                display:flex;align-items:center;gap:.75rem;
            }
            .star-controls button{
                background:var(--input-bg);border:1px solid var(--border);border-radius:6px;
                padding:.45rem .9rem;cursor:pointer;font-size:1rem;color:var(--text);
                transition:border-color .2s,background .2s;
                user-select:none;
            }
            .star-controls button:hover{border-color:var(--accent)}
            .star-controls button:active{background:var(--accent);color:#fff}
            .star-value{
                font-weight:700;font-size:1rem;min-width:3.5em;text-align:center;
                color:var(--text);font-variant-numeric:tabular-nums;
            }
            @keyframes starBounce{
                0%  {transform:scale(1)}
                15% {transform:scale(1.25)}
                30% {transform:scale(0.9)}
                45% {transform:scale(1.15)}
                60% {transform:scale(0.95)}
                75% {transform:scale(1.05)}
                100%{transform:scale(1)}
            }
            .star-display.bounce{
                animation:starBounce .6s ease;
            }

            /* Inline demo embed in posts */
            .inline-demo{
                margin:.75rem 0;padding:1rem;background:var(--card);
                border:1px solid var(--border);border-radius:8px;
                box-shadow:0 1px 3px rgba(0,0,0,0.06);
            }
            .inline-demo-label{
                font-size:.75rem;color:var(--muted);margin-bottom:.5rem;
                display:flex;align-items:center;gap:.35rem;
            }

            @media (max-width:520px){
                body{padding:1rem}
            }
        </style>
    </head>
    <body>
        <div class="site">
            <header>
                <div>
                    <h1>Vincent Untiedt Tech Experimentation Blog</h1>
                    <div class="subtitle">A very simple Blog where I post my daily after-work Experimentation. Effort is usually between 15-30 minutes. Goal is a Post per day, Life permitting.</div>
                </div>
                <div class="controls">
                    <input id="search" class="search" placeholder="Filter posts by name or text..." />
                    <select id="sort" class="select" aria-label="Sort by date">
                        <option value="date-desc">Date: Newest first</option>
                        <option value="date-asc">Date: Oldest first</option>
                    </select>
                    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme" title="Toggle light/dark theme">üåô</button>
                </div>
            </header>

            <div class="tabs">
                <button class="tab-btn active" data-tab="posts-panel">üìù Posts</button>
                <button class="tab-btn" data-tab="calendar-panel">üìÖ Calendar</button>
                <button class="tab-btn" data-tab="stats-panel">üìä Stats</button>
                <button class="tab-btn" data-tab="demo-panel">üß™ Demo</button>
            </div>

            <main>
                <div id="posts-panel" class="tab-panel active">
                    <div id="posts" class="posts" aria-live="polite">
                        <div class="empty">Loading posts...</div>
                    </div>
                </div>
                <div id="calendar-panel" class="tab-panel">
                    <div class="cal-nav">
                        <button id="cal-prev" aria-label="Previous month">‚óÄ</button>
                        <span class="cal-month-label" id="cal-month-label"></span>
                        <button id="cal-next" aria-label="Next month">‚ñ∂</button>
                    </div>
                    <div class="cal-grid" id="cal-grid"></div>
                </div>
                <div id="stats-panel" class="tab-panel">
                    <div class="stats-controls">
                        <label for="metric-select">Metric:</label>
                        <select id="metric-select" class="select" aria-label="Select metric"></select>
                    </div>
                    <div class="chart-container">
                        <canvas id="stats-chart"></canvas>
                    </div>
                    <div class="stats-summary" id="stats-summary"></div>
                </div>
                <div id="demo-panel" class="tab-panel">
                    <div class="demo-grid" id="demo-grid"></div>
                </div>
            </main>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
        <script>
            // Contract:
            // - Fetch posts/list.json (array of filenames relative to posts/)
            // - For each filename, fetch 'posts/' + filename and render a <details>
            // - The summary header shows the filename; the body contains the file text

            const postsEl = document.getElementById('posts');
            const searchEl = document.getElementById('search');
            const sortEl = document.getElementById('sort');

            function normalizeEntry(entry){
                if(typeof entry === 'string'){
                    return { file: entry };
                }
                if(entry && typeof entry === 'object'){
                    const file = typeof entry.file === 'string'
                        ? entry.file
                        : typeof entry.filename === 'string'
                            ? entry.filename
                            : typeof entry.name === 'string'
                                ? entry.name
                                : '';
                    return {
                        file,
                        date: typeof entry.date === 'string' ? entry.date : '',
                        title: typeof entry.title === 'string' ? entry.title : ''
                    };
                }
                return { file: '' };
            }

            function getDisplayTitle(file, title){
                if(title && title.trim()) return title.trim();
                const base = file.replace(/\.txt$/i, '');
                return base || file;
            }

            function parseDateValue(dateStr){
                if(!dateStr) return NaN;
                const t = Date.parse(dateStr);
                return Number.isNaN(t) ? NaN : t;
            }

            async function loadList(){
                try{
                    const r = await fetch('posts/list.json', {cache: 'no-store'});
                    if(!r.ok) throw new Error('Could not load posts/list.json');
                    const list = await r.json();
                    if(!Array.isArray(list) || list.length===0){
                        postsEl.innerHTML = '<div class="empty">No posts found.</div>';
                        return;
                    }
                    postsEl.innerHTML = '';
                    const entries = list.map(normalizeEntry).filter(e=>typeof e.file === 'string' && e.file.trim().length>0);
                    const sorted = sortEntries(entries, sortEl.value);
                    for(const entry of sorted){
                        renderPostPlaceholder(entry);
                        fetchAndFill(entry);
                    }
                }catch(err){
                    console.error(err);
                    postsEl.innerHTML = '<div class="empty">Failed to load posts.</div>';
                }
            }

            function sortEntries(entries, sortMode){
                const dir = sortMode === 'date-asc' ? 1 : -1;
                return [...entries].sort((a,b)=>{
                    const da = parseDateValue(a.date);
                    const db = parseDateValue(b.date);
                    const aHas = !Number.isNaN(da);
                    const bHas = !Number.isNaN(db);
                    if(aHas && bHas) return (da - db) * dir;
                    if(aHas && !bHas) return -1;
                    if(!aHas && bHas) return 1;
                    return a.file.localeCompare(b.file);
                });
            }

            function renderPostPlaceholder(entry){
                const filename = entry.file;
                const d = document.createElement('details');
                d.className = 'post';
                d.dataset.filename = filename;
                d.dataset.title = getDisplayTitle(filename, entry.title);
                d.dataset.date = entry.date || '';

                const s = document.createElement('summary');
                s.className = 'post-header';
                s.textContent = d.dataset.title;

                const meta = document.createElement('div');
                meta.className = 'meta';
                meta.textContent = 'Loading...';

                const content = document.createElement('div');
                content.className = 'post-content';
                content.textContent = '';

                d.appendChild(s);
                d.appendChild(meta);
                d.appendChild(content);
                postsEl.appendChild(d);
            }

            async function fetchAndFill(entry){
                const filename = entry.file;
                const path = 'posts/' + filename;
                try{
                    const r = await fetch(path, {cache: 'no-store'});
                    const d = postsEl.querySelector(`details[data-filename="${filename}"]`);
                    if(!r.ok){
                        d.querySelector('.meta').textContent = 'Error loading';
                        d.querySelector('.post-content').textContent = `Failed to fetch ${filename} ‚Äî ${r.status}`;
                        return;
                    }
                    const txt = await r.text();
                    const lines = txt.split('\n');
                    const firstLine = lines.find(l=>l.trim().length>0) || '';
                    const dateLabel = entry.date ? `Date: ${entry.date}` : '';
                    const preview = firstLine ? firstLine.slice(0,120) : 'Text file';
                    d.querySelector('.meta').textContent = dateLabel ? `${dateLabel} ‚Ä¢ ${preview}` : preview;
                    // Parse $imagename$ patterns and convert to <img> tags
                    const htmlContent = renderContent(txt);
                    d.querySelector('.post-content').innerHTML = htmlContent;
                }catch(err){
                    console.error(err);
                    const d = postsEl.querySelector(`details[data-filename="${filename}"]`);
                    if(d){
                        d.querySelector('.meta').textContent = 'Error';
                        d.querySelector('.post-content').textContent = String(err);
                    }
                }
            }

            // Convert plain text to HTML, replacing $imagename$ with <img> tags
            // and #demoname# with inline interactive demos
            function renderContent(txt){
                // Escape HTML special chars first
                const escaped = txt
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                // Replace $imagename$ with <img src="pictures/imagename">
                // Pattern: $filename.ext$ where filename can have letters, numbers, dashes, underscores
                const withImages = escaped.replace(/\$([a-zA-Z0-9_\-\.]+)\$/g, (match, imgName) => {
                    return `<img src="pictures/${imgName}" alt="${imgName}" loading="lazy">`;
                });
                // Replace #demoname# with inline demo containers
                const withDemos = withImages.replace(/#([a-zA-Z0-9_\-]+)#/g, (match, demoName) => {
                    if(!DEMOS[demoName]) return match;
                    const uid = 'inline-demo-' + demoName + '-' + Math.random().toString(36).slice(2,8);
                    // Schedule rendering after the HTML is inserted into the DOM
                    setTimeout(() => {
                        const container = document.getElementById(uid);
                        if(container && !container.dataset.init){
                            container.dataset.init = '1';
                            DEMOS[demoName](container);
                        }
                    }, 0);
                    return `<div class="inline-demo" id="${uid}"><div class="inline-demo-label">üß™ Interactive Demo: ${demoName}</div></div>`;
                });
                // Convert plain URLs into clickable links (skip URLs already inside HTML attributes)
                const withLinks = withDemos.replace(/(^|[^"'=])(https?:\/\/[^\s<)]+)/g, (m, pre, url) => {
                    return `${pre}<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
                });
                return withLinks;
            }

            function filterPosts(q){
                q = q.trim().toLowerCase();
                const items = postsEl.querySelectorAll('details.post');
                for(const item of items){
                    const name = (item.dataset.title || item.dataset.filename).toLowerCase();
                    const body = (item.querySelector('.post-content')?.textContent || '').toLowerCase();
                    const show = !q || name.includes(q) || body.includes(q);
                    item.style.display = show ? '' : 'none';
                }
            }

            searchEl.addEventListener('input', e=>filterPosts(e.target.value));
            sortEl.addEventListener('change', ()=>loadList());

            // ---- Theme toggle ----
            const themeBtn = document.getElementById('theme-toggle');

            function getEffectiveTheme(){
                const saved = localStorage.getItem('theme');
                if(saved === 'dark' || saved === 'light') return saved;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            function applyThemeIcon(){
                themeBtn.textContent = getEffectiveTheme() === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }

            themeBtn.addEventListener('click', ()=>{
                const current = getEffectiveTheme();
                const next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
                applyThemeIcon();
            });

            // Listen for OS theme changes (only applies when no manual override)
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{
                if(!localStorage.getItem('theme')){
                    applyThemeIcon();
                }
            });

            applyThemeIcon();

            // ---- Tab switching ----
            document.querySelectorAll('.tab-btn').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                    document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                });
            });

            // ---- Calendar ----
            const calGrid = document.getElementById('cal-grid');
            const calLabel = document.getElementById('cal-month-label');
            let calYear, calMonth; // 0-indexed month
            let postDateMap = {}; // 'YYYY-MM-DD' -> [{file, title}]

            async function loadCalendarData(){
                try{
                    const r = await fetch('posts/list.json', {cache:'no-store'});
                    const list = await r.json();
                    postDateMap = {};
                    for(const raw of list){
                        const e = normalizeEntry(raw);
                        if(e.date){
                            const d = e.date;
                            if(!postDateMap[d]) postDateMap[d] = [];
                            postDateMap[d].push({file: e.file, title: getDisplayTitle(e.file, e.title)});
                        }
                    }
                    const now = new Date();
                    calYear = now.getFullYear();
                    calMonth = now.getMonth();
                    renderCalendar();
                }catch(e){console.error(e);}
            }

            function renderCalendar(){
                const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                calLabel.textContent = `${monthNames[calMonth]} ${calYear}`;
                calGrid.innerHTML = '';
                const dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
                for(const dn of dayNames){
                    const el = document.createElement('div');
                    el.className = 'cal-day-name';
                    el.textContent = dn;
                    calGrid.appendChild(el);
                }
                const firstDay = new Date(calYear, calMonth, 1);
                let startDow = firstDay.getDay(); // 0=Sun
                startDow = startDow === 0 ? 6 : startDow - 1; // convert to Mon=0
                const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
                for(let i=0;i<startDow;i++){
                    const blank = document.createElement('div');
                    blank.className = 'cal-cell empty';
                    calGrid.appendChild(blank);
                }
                for(let day=1;day<=daysInMonth;day++){
                    const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                    const cell = document.createElement('div');
                    cell.className = 'cal-cell';
                    cell.textContent = day;
                    if(dateStr === todayStr) cell.classList.add('today');
                    if(postDateMap[dateStr]){
                        cell.classList.add('has-post');
                        const entries = postDateMap[dateStr];
                        const tip = document.createElement('span');
                        tip.className = 'cal-tooltip';
                        tip.textContent = entries.map(e=>e.title).join(', ');
                        cell.appendChild(tip);
                        cell.addEventListener('click',()=>{
                            // Switch to Posts tab
                            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                            document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
                            document.querySelector('.tab-btn[data-tab="posts-panel"]').classList.add('active');
                            document.getElementById('posts-panel').classList.add('active');
                            // Open and scroll to the first matching post
                            const fname = entries[0].file;
                            const det = postsEl.querySelector(`details[data-filename="${fname}"]`);
                            if(det){
                                det.open = true;
                                det.scrollIntoView({behavior:'smooth',block:'center'});
                            }
                        });
                    }
                    calGrid.appendChild(cell);
                }
            }

            document.getElementById('cal-prev').addEventListener('click',()=>{
                calMonth--;
                if(calMonth<0){calMonth=11;calYear--;}
                renderCalendar();
            });
            document.getElementById('cal-next').addEventListener('click',()=>{
                calMonth++;
                if(calMonth>11){calMonth=0;calYear++;}
                renderCalendar();
            });

            // ---- Stats tab ----
            const metricSelect = document.getElementById('metric-select');
            const statsSummary = document.getElementById('stats-summary');
            let statsData = [];      // raw array from stats.json
            let statsChart = null;   // Chart.js instance

            // Human-readable labels for each metric key
            const metricLabels = {
                keystrokes:  'Keystrokes',
                timeElapsed: 'Time Elapsed'
            };

            // Convert "hh:mm:ss" to total minutes (decimal) for charting
            function hmsToMinutes(str){
                if(!str) return 0;
                const parts = str.split(':').map(Number);
                if(parts.length === 3) return parts[0]*60 + parts[1] + parts[2]/60;
                if(parts.length === 2) return parts[0] + parts[1]/60;
                return parts[0] || 0;
            }

            // Format minutes back to "hh:mm:ss" for tooltip display
            function minutesToHms(m){
                const h = Math.floor(m / 60);
                const min = Math.floor(m % 60);
                const sec = Math.round((m - Math.floor(m)) * 60);
                return `${String(h).padStart(2,'0')}:${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
            }

            // Auto-discover metric keys from the data (ignores file, date)
            function discoverMetrics(data){
                const skip = new Set(['file','date']);
                const keys = new Set();
                for(const entry of data){
                    for(const k of Object.keys(entry)){
                        if(!skip.has(k)) keys.add(k);
                    }
                }
                return [...keys];
            }

            // Determine if a metric looks like a time field (contains ":")
            function isTimeMetric(key, data){
                for(const e of data){
                    if(typeof e[key] === 'string' && e[key].includes(':')) return true;
                }
                return false;
            }

            // Get the numeric value for a metric (auto-converts time strings)
            function metricValue(entry, key, isTime){
                const raw = entry[key];
                if(raw == null) return null;
                if(isTime) return hmsToMinutes(raw);
                return typeof raw === 'number' ? raw : parseFloat(raw) || 0;
            }

            function getChartColors(){
                const style = getComputedStyle(document.documentElement);
                return {
                    accent: style.getPropertyValue('--accent').trim() || '#2b6cb0',
                    text:   style.getPropertyValue('--text').trim()   || '#111',
                    muted:  style.getPropertyValue('--muted').trim()  || '#666',
                    border: style.getPropertyValue('--border').trim() || '#ddd',
                    card:   style.getPropertyValue('--card').trim()   || '#fff'
                };
            }

            function renderStatsChart(metricKey){
                if(!statsData.length) return;
                const isTime = isTimeMetric(metricKey, statsData);
                const sorted = [...statsData]
                    .filter(e => e.date && e[metricKey] != null)
                    .sort((a,b) => a.date.localeCompare(b.date));

                const labels = sorted.map(e => {
                    const title = e.file ? e.file.replace(/\.txt$/i,'') : e.date;
                    return `${e.date}  (${title})`;
                });
                const values = sorted.map(e => metricValue(e, metricKey, isTime));
                const colors = getChartColors();
                const label = metricLabels[metricKey] || metricKey;
                const yLabel = isTime ? `${label} (minutes)` : label;

                if(statsChart) statsChart.destroy();

                statsChart = new Chart(document.getElementById('stats-chart'), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label,
                            data: values,
                            borderColor: colors.accent,
                            backgroundColor: colors.accent + '22',
                            pointBackgroundColor: colors.accent,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.25,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: colors.text } },
                            tooltip: {
                                callbacks: {
                                    label: ctx => {
                                        const v = ctx.parsed.y;
                                        if(isTime) return `${label}: ${minutesToHms(v)}`;
                                        return `${label}: ${v.toLocaleString()}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: colors.muted, maxRotation: 45 },
                                grid:  { color: colors.border + '44' }
                            },
                            y: {
                                title: { display: true, text: yLabel, color: colors.muted },
                                ticks: {
                                    color: colors.muted,
                                    callback: v => isTime ? minutesToHms(v) : v.toLocaleString()
                                },
                                grid:  { color: colors.border + '44' },
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Summary cards
                const total = values.reduce((s,v) => s + v, 0);
                const avg   = values.length ? total / values.length : 0;
                const max   = Math.max(...values);
                const fmt   = v => isTime ? minutesToHms(v) : v.toLocaleString(undefined,{maximumFractionDigits:0});

                statsSummary.innerHTML = `
                    <div class="stat-card"><div class="stat-value">${fmt(total)}</div><div class="stat-label">Total ${label}</div></div>
                    <div class="stat-card"><div class="stat-value">${fmt(avg)}</div><div class="stat-label">Average per Post</div></div>
                    <div class="stat-card"><div class="stat-value">${fmt(max)}</div><div class="stat-label">Max in a Session</div></div>
                    <div class="stat-card"><div class="stat-value">${values.length}</div><div class="stat-label">Posts with Data</div></div>
                `;
            }

            async function loadStats(){
                try{
                    const r = await fetch('stats.json', {cache:'no-store'});
                    if(!r.ok) throw new Error(`stats.json ${r.status}`);
                    statsData = await r.json();
                    if(!Array.isArray(statsData) || !statsData.length){
                        document.querySelector('#stats-panel .chart-container').innerHTML = '<div class="stats-empty">No stats data yet.</div>';
                        return;
                    }
                    // Populate metric dropdown from discovered keys
                    const metrics = discoverMetrics(statsData);
                    metricSelect.innerHTML = '';
                    for(const key of metrics){
                        const opt = document.createElement('option');
                        opt.value = key;
                        opt.textContent = metricLabels[key] || key;
                        metricSelect.appendChild(opt);
                    }
                    metricSelect.addEventListener('change', () => renderStatsChart(metricSelect.value));
                    // Initial render
                    if(metrics.length) renderStatsChart(metrics[0]);
                }catch(err){
                    console.error('Stats load error:', err);
                    document.querySelector('#stats-panel .chart-container').innerHTML = '<div class="stats-empty">Could not load stats.</div>';
                }
            }

            // Re-render chart when theme changes so colors update
            const origThemeClick = themeBtn.onclick;
            themeBtn.addEventListener('click', () => {
                setTimeout(() => {
                    if(statsChart && metricSelect.value) renderStatsChart(metricSelect.value);
                }, 50);
            });

            // ---- Demo registry & widgets ----
            const DEMOS = {};

            // Star-selector demo builder
            DEMOS['star-selector'] = function(container){
                let rating = 2.5;
                const INTERVAL_MS = 50; // tick interval when holding button
                // Asymptotic step: fast near 2.5, very slow near 0 or 5.
                // 30s to reach limit from 2.5 means ~600 ticks.
                // Using step = k * distance^2 where integral from 0 to 2.5 = 2.5
                // integral of k*d^2 dd from 0 to 2.5 = k*(2.5^3)/3 = 2.5  =>  k = 3/(2.5^2) = 0.48
                // But we want 30s = 600 ticks, so step per tick = (0.48 * d^2) / (sum of steps)
                // Simpler: step = baseStep * (distance / 2.5)^2, baseStep tuned so sum ‚âà 2.5 in 600 ticks
                // We'll use a continuous approach: step = 0.008 * (distance)^1.5
                // This gives very slow approach near limits.
                function getStep(dir){
                    const distance = dir > 0 ? (5 - rating) : rating;
                    if(distance <= 0) return 0;
                    // Tuned so reaching 0 or 5 from 2.5 takes ~30s of holding (600 ticks at 50ms)
                    // Min step of 0.002 ensures progress isn't killed by float rounding
                    return Math.max(0.002, 0.006 * Math.pow(distance, 1.6));
                }

                const wrapper = document.createElement('div');
                wrapper.className = 'star-widget';

                // Star display
                const starDisplay = document.createElement('div');
                starDisplay.className = 'star-display';
                const stars = [];
                for(let i = 0; i < 5; i++){
                    const unit = document.createElement('span');
                    unit.className = 'star-unit';
                    unit.innerHTML = '<span class="star-fill">‚òÖ</span>‚òÖ';
                    stars.push(unit);
                    starDisplay.appendChild(unit);
                }

                // Controls
                const controls = document.createElement('div');
                controls.className = 'star-controls';
                const btnDown = document.createElement('button');
                btnDown.textContent = '‚óÄ ‚àí';
                btnDown.title = 'Hold to decrease';
                const valueLabel = document.createElement('span');
                valueLabel.className = 'star-value';
                const btnUp = document.createElement('button');
                btnUp.textContent = '+ ‚ñ∂';
                btnUp.title = 'Hold to increase';
                controls.appendChild(btnDown);
                controls.appendChild(valueLabel);
                controls.appendChild(btnUp);

                wrapper.appendChild(starDisplay);
                wrapper.appendChild(controls);
                container.appendChild(wrapper);

                function updateDisplay(){
                    rating = Math.round(rating * 1000) / 1000; // avoid float noise
                    if(rating < 0) rating = 0;
                    if(rating > 5) rating = 5;
                    for(let i = 0; i < 5; i++){
                        const fill = Math.max(0, Math.min(1, rating - i));
                        stars[i].querySelector('.star-fill').style.width = (fill * 100) + '%';
                    }
                    valueLabel.textContent = rating.toFixed(2) + ' ‚òÖ';

                    // Bounce at 5
                    if(rating >= 5){
                        starDisplay.classList.remove('bounce');
                        void starDisplay.offsetWidth; // reflow to restart animation
                        starDisplay.classList.add('bounce');
                    }
                }

                // Hold-to-change mechanism
                function setupHold(btn, dir){
                    let intervalId = null;
                    function tick(){
                        const step = getStep(dir);
                        if(step <= 0.0001) return;
                        rating += step * dir;
                        updateDisplay();
                    }
                    function startHold(e){
                        e.preventDefault();
                        tick(); // immediate first tick
                        intervalId = setInterval(tick, INTERVAL_MS);
                    }
                    function stopHold(){
                        if(intervalId){ clearInterval(intervalId); intervalId = null; }
                    }
                    btn.addEventListener('mousedown', startHold);
                    btn.addEventListener('mouseup', stopHold);
                    btn.addEventListener('mouseleave', stopHold);
                    btn.addEventListener('touchstart', startHold, {passive:false});
                    btn.addEventListener('touchend', stopHold);
                    btn.addEventListener('touchcancel', stopHold);
                }

                setupHold(btnDown, -1);
                setupHold(btnUp, 1);
                updateDisplay();
            };

            // Build demo panel cards
            function buildDemoPanel(){
                const grid = document.getElementById('demo-grid');
                if(!grid) return;
                grid.innerHTML = '';
                const demoList = [
                    { id: 'star-selector', title: '0‚Äì5 Star Selector', desc: 'Asymptotic star rating ‚Äî hold the buttons to change. Slows dramatically near 0 and 5. Bounce animation at max!' }
                ];
                for(const demo of demoList){
                    const card = document.createElement('div');
                    card.className = 'demo-card';
                    const h3 = document.createElement('h3');
                    h3.textContent = demo.title;
                    const p = document.createElement('p');
                    p.className = 'demo-desc';
                    p.textContent = demo.desc;
                    const target = document.createElement('div');
                    card.appendChild(h3);
                    card.appendChild(p);
                    card.appendChild(target);
                    grid.appendChild(card);
                    if(DEMOS[demo.id]) DEMOS[demo.id](target);
                }
            }

            // Kick off
            loadList();
            loadCalendarData();
            loadStats();
            buildDemoPanel();
        </script>
    </body>
</html>
